<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NHC Ping Monitor</title>
  <meta http-equiv="refresh" content="15">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --primary: #3b82f6;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --radius: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; padding: 1rem; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* Header */
    .header { text-align: center; margin-bottom: 1.5rem; padding: 1rem; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); }
    .header h1 { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
    .header p { color: var(--text-light); font-size: 0.95rem; margin-top: 0.25rem; }

    /* Status Bar */
    .status-bar { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 0.75rem 1rem; border-radius: var(--radius); margin-bottom: 1.5rem; box-shadow: var(--shadow); font-size: 0.9rem; flex-wrap: wrap; gap: 1rem; }
    .status-item { display: flex; align-items: center; gap: 0.5rem; cursor:pointer; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .dot.active { background: var(--success); }
    .dot.inactive { background: var(--danger); }

    /* Search Box */
    .search-box { margin-bottom: 1.5rem; text-align: center; }
    #regionSearch { padding: 0.75rem 1rem; font: 1rem 'Inter', sans-serif; border: 1px solid var(--border); border-radius: 8px; background: white; width: 100%; max-width: 360px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); outline: none; transition: all 0.2s; }
    #regionSearch:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Cards Grid */
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(330px,1fr)); gap: 1.5rem; }
    .region-card { background: var(--card); border-radius: var(--radius); padding: 1rem; box-shadow: var(--shadow); opacity: 0; transform: translateY(10px); animation: fadeIn 0.4s ease-out forwards; }
    .region-card.hidden { display: none; }
    .region-card h2 { font-size: 1.3rem; font-weight: 600; color: var(--text); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
    .region-card h2::before { content: ""; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; }

    /* Table */
    .table-wrapper { overflow-x: auto; border-radius: 8px; }
    table { width: 100%; min-width: 340px; border-collapse: collapse; font-size: 0.9rem; }
    th { background: #f1f5f9; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 0.75rem 0.5rem; text-align: left; color: #475569; }
    td { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border); }
    tr:last-child td { border-bottom: none; }
    .status { padding: 0.25rem 0.5rem; border-radius: 6px; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
    .status.active { background: #d1fae5; color: var(--success); }
    .status.inactive { background: #fee2e2; color: var(--danger); }

    /* Pagination */
    .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin: 2rem 0; }
    .pagination button { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; background: var(--primary); color: #fff; cursor: pointer; font-weight: 600; box-shadow: var(--shadow); }
    .pagination button:disabled { background: #cbd5e1; cursor: not-allowed; }
    #pageInfo { font-weight: 600; color: var(--text-light); }

    /* Footer */
    .footer { text-align: center; padding: 1.5rem; color: var(--text-light); font-size: 0.85rem; margin-top: 2rem; }

    /* Animations */
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

    /* Mobile */
    @media (max-width: 640px) { 
      .header h1 { font-size: 1.5rem; }
      .status-bar { flex-direction: column; text-align: center; }
      .status-item { justify-content: center; }
      th, td { padding: 0.5rem 0.4rem; font-size: 0.8rem; }
      .region-card h2 { font-size: 1.1rem; }
      #regionSearch { max-width: none; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <h1>NHC Ping Monitor</h1>
      <p><em>Real-time network status from local infrastructures</em></p>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item" onclick="showOnly('active')">
        <span class="dot active"></span> <span id="active-count">0</span> Active
      </div>
      <div class="status-item" onclick="showOnly('inactive')">
        <span class="dot inactive"></span> <span id="inactive-count">0</span> Down
      </div>
      <div class="status-item">
        <strong>Last update:</strong> <span id="last-update"><em>Waiting for data…</em></span>
        <span style="color:#2e8b57;"> (from local network)</span>
      </div>
    </div>

    <!-- Search Box -->
    <div class="search-box">
      <input type="text" id="regionSearch" placeholder="Search region..." onkeyup="filterRegions()">
    </div>

    <!-- Cards Grid -->
    <div id="cards-container" class="cards-grid">
      {% for region, items in results.items() %}
        <div class="region-card card-item" data-region="{{ region }}">
          <h2>{{ region }}</h2>
          <div class="table-wrapper">
            <table>
              <tr><th>Type</th><th>IP</th><th>Status</th></tr>
              {% for it in items %}
              <tr>
                <td><strong>{{ it.label }}</strong></td>
                <td><code>{{ it.ip }}</code></td>
                <td>
                  <span class="status {{ 'active' if it.status == 'ACTIVE' else 'inactive' }}">{{ it.status }}</span>
                </td>
              </tr>
              {% endfor %}
            </table>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button id="prevBtn" onclick="prevPage()">Prev</button>
      <span id="pageInfo"></span>
      <button id="nextBtn" onclick="nextPage()">Next</button>
    </div>

    <!-- Footer -->
    <div class="footer">
      NHC Network Operations • Auto-refreshes every 15 seconds
    </div>

    <!-- Hidden datetime -->
    <div id="full-datetime" style="display:none;">{{ last_update }}</div>
  </div>
  
<script>
let cards = [], currentPage = 1, perPage = 6;
let statusFilter = null; // null, "active", or "inactive"

// Initialize card list
function setCardsList() { cards = [...document.querySelectorAll(".card-item")]; }

// Render pagination
function renderPagination() {
  const visibleCards = cards.filter(c => !c.classList.contains('hidden'));
  const totalPages = Math.ceil(visibleCards.length / perPage);
  if(currentPage > totalPages) currentPage = totalPages || 1;

  const start = (currentPage - 1) * perPage;
  const end = start + perPage;

  cards.forEach((c, i) => {
    c.style.display = (!c.classList.contains('hidden') && visibleCards.indexOf(c) >= start && visibleCards.indexOf(c) < end) ? "block" : "none";
  });

  document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages || 1}`;
  document.getElementById("prevBtn").disabled = currentPage === 1;
  document.getElementById("nextBtn").disabled = currentPage >= totalPages;
}

// Pagination controls
function nextPage() { currentPage++; renderPagination(); }
function prevPage() { if(currentPage > 1){ currentPage--; renderPagination(); } }

// Apply filters (search + status)
function applyFilters() {
  const query = document.getElementById('regionSearch').value.trim().toLowerCase();
  let active = 0, inactive = 0;

  cards.forEach(card => {
    const regionName = card.dataset.region.toLowerCase();
    let matchesQuery = regionName.includes(query);

    // Check status filter
    let matchesStatus = true;
    if(statusFilter){
      matchesStatus = false;
      card.querySelectorAll('table tr:not(:first-child)').forEach(row => {
        const status = row.querySelector('.status');
        if(status?.classList.contains(statusFilter)) matchesStatus = true;
      });
    }

    const show = matchesQuery && matchesStatus;
    card.classList.toggle('hidden', !show);

    // Count active/inactive only if visible
    if(show){
      card.querySelectorAll('table tr:not(:first-child)').forEach(row => {
        const status = row.querySelector('.status');
        if(status?.classList.contains('active')) active++;
        else if(status?.classList.contains('inactive')) inactive++;
      });
    }
  });

  document.getElementById('active-count').textContent = active;
  document.getElementById('inactive-count').textContent = inactive;

  currentPage = 1;
  renderPagination();
}

// Search input
function filterRegions() {
  applyFilters();
}

// Show only active/inactive
function showOnly(type){
  if(statusFilter === type) statusFilter = null; // toggle off
  else statusFilter = type;
  applyFilters();
}

// Update last update date
function updateLastUpdateDate() {
  const fullTime=document.getElementById('full-datetime')?.textContent.trim();
  if(fullTime) document.getElementById('last-update').textContent = fullTime;
}

window.addEventListener('load', () => {
  setCardsList();
  applyFilters(); // Initial render + counts
  updateLastUpdateDate();
  document.querySelectorAll('.card-item').forEach((c,i)=>c.style.animationDelay=`${i*0.05}s`);
});

// Auto-scroll search box
document.getElementById('regionSearch').addEventListener('focus', function(){
  setTimeout(()=>{ this.scrollIntoView({behavior:'smooth', block:'nearest'}); }, 300);
});
</script>

</body>
</html>
